<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AQI_01 — Dashboard ThingSpeak (v2)</title>
  <style>
    :root{
      --bg: #e8f5e9;
      --card: #ffffff;
      --text: #0b2535;
      --muted: #5a6b74;
      --accent: #d62020;
      --shadow: 0 6px 18px rgba(11,37,53,0.08);
    }
    [data-theme="dark"]{
      --bg: #0b1113;
      --card: #0f1a1c;
      --text: #e6f2f1;
      --muted: #a6b3b1;
      --accent: #ff6b6b;
      --shadow: 0 6px 18px rgba(0,0,0,0.6);
    }

    *{box-sizing:border-box}
    body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text);}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px 20px;max-width:1400px;margin:12px auto;border-radius:12px}
    .title{display:flex;flex-direction:column}
    h1{margin:0;font-size:1.4rem}
    .subtitle{font-size:0.92rem;color:var(--muted);margin-top:6px}

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .control-group{background:var(--card);padding:10px;border-radius:8px;box-shadow:var(--shadow);display:flex;align-items:center;gap:8px}
    label.small{font-size:0.85rem;color:var(--muted)}
    input[type=date], button, select{padding:8px 10px;border-radius:6px;border:1px solid #d0d7d9;background:transparent}
    button.primary{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}

    main{max-width:1400px;margin:18px auto;padding:12px}
    .top-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:14px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:flex-start}
    .card .label{font-size:0.85rem;color:var(--muted)}
    .card .value{font-size:1.2rem;font-weight:700;margin-top:6px}
    .aqi-badge{margin-left:auto;padding:6px 10px;border-radius:8px;font-weight:700}

    .middle{display:flex;gap:12px;flex-wrap:wrap}
    .left-panel{flex:1;min-width:260px}
    .right-panel{flex:2;min-width:300px}

    .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow)}
    .fields-list{display:flex;flex-direction:column;gap:8px}
    .fields-list label{display:flex;align-items:center;gap:8px}

    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-top:12px}
    .chart-box{background:var(--card);padding:8px;border-radius:8px;box-shadow:var(--shadow);min-height:280px;display:flex;flex-direction:column}
    .chart-box iframe{flex:1;border:0;border-radius:6px}

    footer{max-width:1400px;margin:18px auto;text-align:center;color:var(--muted);font-size:0.9rem}

    /* small screens tweaks */
    @media (max-width:700px){header{padding:12px} .controls{flex-direction:column;align-items:stretch} .middle{flex-direction:column} .chart-box{min-height:220px}}
  </style>
</head>
<body>
  <div id="app" data-theme>
    <header>
      <div class="title">
        <h1>Air Quality Index Device — AQI_01 (v2)</h1>

  <div id="aqi-widget" style="max-width:400px;margin:20px auto;padding:20px;border-radius:14px;border:2px solid #999;background:#fff;box-shadow:3px 3px 10px rgba(0,0,0,0.15);text-align:center;font-family:'Segoe UI',sans-serif;">
    <h2 style="margin-top:0;font-size:1.4em;color:#003366;">AQI stimato (EPA USA)</h2>
    <div id="aqi-category" style="display:inline-block;padding:6px 12px;border-radius:8px;font-weight:bold;margin-bottom:10px;background:#ccc;color:#000;">Calcolo...</div>
    <div id="aqi-value" style="font-size:3em;font-weight:bold;color:#003366;">--</div>
    <div style="margin-top:10px;font-size:1.1em;color:#333;">
      PM2.5: <span id="pm25-val">--</span><br>
      PM10: <span id="pm10-val">--</span>
    </div>
  </div>
        <div class="subtitle" id="subtitle">Inizio rilevamento dati:</div>
      </div>

      <div class="controls">
        <div class="control-group">
          <label class="small">Inizio</label>
          <input type="date" id="start-date">
        </div>
        <div class="control-group">
          <label class="small">Fine</label>
          <input type="date" id="end-date">
        </div>
        <div class="control-group">
          <button class="primary" id="btn-update">Aggiorna</button>
        </div>
        <div class="control-group">
          <label class="small">Tema</label>
          <select id="theme-select">
            <option value="auto">Auto</option>
            <option value="light">Chiaro</option>
            <option value="dark">Scuro</option>
          </select>
        </div>
      </div>
    </header>

    <main>
      <section class="top-cards" id="last-values">
        <!-- cards injected here -->
      </section>

      <div class="middle">
        <aside class="left-panel">
          <div class="panel">
            <h3 style="margin-top:0">Configura grafici</h3>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <button id="btn-select-all">Seleziona tutti</button>
              <button id="btn-clear-all">Deseleziona tutti</button>
            </div>
            <div class="fields-list" id="fields-list"></div>

            <hr style="margin:10px 0">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="save-prefs"> Ricorda preferenze</label>
            <p style="color:var(--muted);font-size:0.9rem;margin-top:8px">Puoi mostrare/nascondere singoli grafici, impostare intervallo e tema. Le preferenze sono salvate nel tuo browser se attivi "Ricorda".</p>
          </div>
        </aside>

        <section class="right-panel">
          <div class="panel">
            <h3 style="margin-top:0">Grafici</h3>
            <div id="charts-warning" style="color:#7a1a1a;font-weight:700;display:none;margin-bottom:8px"></div>
            <div class="charts-grid" id="grafici-container"></div>
          </div>
        </section>
      </div>

    </main>

    <footer>
      Versione 2 — compatibile con ThingSpeak. Channel ID impostato in script.
    </footer>
  </div>

  <script>
    /* ==================== CONFIG ==================== */
    const channelID = 2789658; // imposta qui il tuo channel ID

    const campi = [
      { id: 1, key: 'humidity', title: 'Umidità - BME680', unit: '%', min:0, max:100 },
      { id: 2, key: 'temperature', title: 'Temperatura - BME680', unit: '°C', min:-10, max:60 },
      { id: 3, key: 'pressure', key2:'pressure', title: 'Pressione - BME680', unit: 'hPa', min:900, max:1100 },
      { id: 5, key: 'pm1', title: 'PM1 - PMS5003', unit: 'µg/m³', min:0, max:500 },
      { id: 6, key: 'pm25', title: 'PM2.5 - PMS5003', unit: 'µg/m³', min:0, max:500 },
      { id: 7, key: 'pm10', title: 'PM10 - PMS5003', unit: 'µg/m³', min:0, max:500 }
    ];

    const prefsKey = 'aqi01_prefs_v2';

    /* ==================== HELPERS ==================== */
    function $(s){return document.querySelector(s)}
    function $all(s){return Array.from(document.querySelectorAll(s))}
    function toISODate(d){return d.toISOString().slice(0,10)}
    function formatLongDate(d){return d.toLocaleDateString('it-IT',{year:'numeric',month:'long',day:'numeric'})}

    function formatStart(dt){
      const Y = dt.getFullYear(), M=('0'+(dt.getMonth()+1)).slice(-2), D=('0'+dt.getDate()).slice(-2);
      return `${Y}-${M}-${D}%2000:00:00`;
    }

    function formatEnd(dt){
      const Y = dt.getFullYear(), M=('0'+(dt.getMonth()+1)).slice(-2), D=('0'+dt.getDate()).slice(-2);
      return `${Y}-${M}-${D}%2023:59:59`;
    }

    /* ==================== AQI CALC ==================== */
    // EPA breakpoints for PM2.5 (µg/m3)
    const bp_pm25 = [
      {cLo:0.0, cHi:12.0, iLo:0, iHi:50},
      {cLo:12.1, cHi:35.4, iLo:51, iHi:100},
      {cLo:35.5, cHi:55.4, iLo:101, iHi:150},
      {cLo:55.5, cHi:150.4, iLo:151, iHi:200},
      {cLo:150.5, cHi:250.4, iLo:201, iHi:300},
      {cLo:250.5, cHi:350.4, iLo:301, iHi:400},
      {cLo:350.5, cHi:500.4, iLo:401, iHi:500}
    ];

    // EPA breakpoints for PM10 (µg/m3)
    const bp_pm10 = [
      {cLo:0, cHi:54, iLo:0, iHi:50},
      {cLo:55, cHi:154, iLo:51, iHi:100},
      {cLo:155, cHi:254, iLo:101, iHi:150},
      {cLo:255, cHi:354, iLo:151, iHi:200},
      {cLo:355, cHi:424, iLo:201, iHi:300},
      {cLo:425, cHi:504, iLo:301, iHi:400},
      {cLo:505, cHi:604, iLo:401, iHi:500}
    ];

    function linearAQI(C, bp){
      if (C === null || C === undefined || isNaN(C)) return null;
      // find interval
      for (const seg of bp){
        if (C >= seg.cLo && C <= seg.cHi){
          const I = Math.round((seg.iHi - seg.iLo)/(seg.cHi - seg.cLo) * (C - seg.cLo) + seg.iLo);
          return I;
        }
      }
      // out of range -> extrapolate
      if (C > bp[bp.length-1].cHi) return Math.round(bp[bp.length-1].iHi + (C - bp[bp.length-1].cHi));
      return null;
    }

    function aqiCategory(aqi){
      if (aqi === null) return {cat:'N/A', color:'#999'};
      if (aqi <=50) return {cat:'Buona', color:'#2e7d32'};
      if (aqi <=100) return {cat:'Moderata', color:'#f9a825'};
      if (aqi <=150) return {cat:'Non salutare per gruppi sensibili', color:'#ef6c00'};
      if (aqi <=200) return {cat:'Non salutare', color:'#d32f2f'};
      if (aqi <=300) return {cat:'Molto non salutare', color:'#7e57c2'};
      return {cat:'Pericolosa', color:'#3e2723'};
    }

    /* ==================== UI BUILD ==================== */
    function buildFieldsList(saved){
      const el = $('#fields-list'); el.innerHTML='';
      campi.forEach(c=>{
        const checked = saved ? saved.visibleFields.includes(String(c.id)) : true;
        const label = document.createElement('label');
        label.innerHTML = `<input type='checkbox' data-field='${c.id}' ${checked? 'checked':''}> ${c.title}`;
        el.appendChild(label);
      });
    }

    function buildCards(last){
      const container = $('#last-values'); container.innerHTML='';
      const pm25 = last['field6'] ? Number(last['field6']) : null;
      const pm10 = last['field7'] ? Number(last['field7']) : null;
      const aqi_pm25 = linearAQI(pm25, bp_pm25);
      const aqi_pm10 = linearAQI(pm10, bp_pm10);
      const aqi_final = [aqi_pm25, aqi_pm10].filter(v=>v!==null).length? Math.max(...[aqi_pm25||0,aqi_pm10||0]) : null;
      const cat = aqiCategory(aqi_final);

      // build value cards for each field
      campi.forEach(c=>{
        const v = last['field'+c.id];
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `<div style='display:flex;width:100%;align-items:center'>
          <div style='flex:1'>
            <div class='label'>${c.title}</div>
            <div class='value'>${v !== undefined && v !== null ? v + ' ' + c.unit : '—'}</div>
          </div>
        </div>`;
        container.appendChild(card);
      });

      // // append EPA AQI card (SOSTITUISCE la precedente)
const aqiCard = document.createElement('div');
aqiCard.className = 'card';

aqiCard.innerHTML = `
  <div style="display:flex;align-items:center;width:100%">
    <div style="flex:1">
      <div class="label">AQI (EPA) – PM2.5 / PM10</div>
      <div class="value">${aqi_final !== null ? aqi_final : '—'}</div>
      <div style="font-size:0.9rem;color:var(--muted)">
        PM2.5: ${aqi_pm25 ?? '—'} · PM10: ${aqi_pm10 ?? '—'}
      </div>
    </div>
    <div class="aqi-badge" style="background:${cat.color}">
      ${cat.cat}
    </div>
  </div>
`;

container.appendChild(aqiCard);


    /* ==================== CHART BUILD ==================== */
    function genIframeSrc(c, startParam, endParam){
      const noc = Date.now();
      const base = `https://thingspeak.com/channels/${channelID}/charts/${c.id}`;
      const params = [];
      params.push(`bgcolor=%23ffffff`);
      params.push(`color=%23d62020`);
      params.push(`type=line`);
      params.push(`dynamic=true`);
      params.push(`title=${encodeURIComponent(c.title)}`);
      params.push(`xaxis=${encodeURIComponent('Data')}`);
      params.push(`yaxis=${encodeURIComponent(c.unit)}`);
      if (startParam) params.push(`start=${startParam}`);
      if (endParam) params.push(`end=${endParam}`);
      if (c.min !== undefined) params.push(`yaxismin=${c.min}`);
      if (c.max !== undefined) params.push(`yaxismax=${c.max}`);
      params.push(`_=${noc}`);
      return base + '?' + params.join('&');
    }

    function renderCharts(settings){
      const container = $('#grafici-container'); container.innerHTML='';
      const startVal = $('#start-date').value;
      const endVal = $('#end-date').value;
      if (!startVal) { $('#charts-warning').textContent='Seleziona una data di inizio valida.'; $('#charts-warning').style.display='block'; return; }
      $('#charts-warning').style.display='none';

      const startDate = new Date(startVal + 'T00:00:00');
      const endDate = endVal ? new Date(endVal + 'T23:59:59') : new Date();
      if (endDate < startDate){ $('#charts-warning').textContent='Data di fine precedente alla data di inizio.'; $('#charts-warning').style.display='block'; return; }

      document.getElementById('subtitle').textContent = 'Inizio rilevamento dati: ' + formatLongDate(startDate) + (endVal ? (' — Fine: ' + formatLongDate(endDate)) : '');

      const startParam = formatStart(startDate);
      const endParam = formatEnd(endDate);

      const visible = settings.visibleFields.map(x=>Number(x));
      campi.forEach(c => {
        if (!visible.includes(c.id)) return;
        const box = document.createElement('div'); box.className='chart-box';
        const src = genIframeSrc(c, startParam, endParam);
        box.innerHTML = `<div style='font-weight:700;margin-bottom:6px'>${c.title}</div><iframe loading='lazy' src='${src}'></iframe>`;
        container.appendChild(box);
      });

      if (container.children.length === 0) {
        container.innerHTML = `<div style='padding:20px;color:var(--muted)'>Nessun grafico selezionato.</div>`;
      }
    }

    /* ==================== PREFERENCES ==================== */
    function loadPrefs(){
      try{
        const raw = localStorage.getItem(prefsKey); if (!raw) return null; return JSON.parse(raw);
      }catch(e){return null}
    }
    function savePrefs(p){
      if (!$('#save-prefs').checked) return;
      localStorage.setItem(prefsKey, JSON.stringify(p));
    }

    /* ==================== DATA FETCH ==================== */
    async function fetchLast(){
      try{
        const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1`);
        const js = await res.json();
        if (js && js.feeds && js.feeds.length) return js.feeds[0];
      }catch(e){console.warn(e)}
      return {};
    }

    /* ==================== BOOT ==================== */
    async function init(){
      // set date limits based on last feed
      const last = await fetchLast();
      const lastDate = last.created_at ? new Date(last.created_at) : new Date();
      const isoLast = toISODate(lastDate);
      const startInput = $('#start-date');
      const endInput = $('#end-date');
      startInput.max = isoLast; endInput.max = isoLast;

      // default min: a reasonable fallback (30 days ago)
      const fallbackMin = new Date(Date.now() - 1000*60*60*24*30);
      const minIso = toISODate(fallbackMin);
      startInput.min = minIso; endInput.min = minIso;

      // load saved prefs or defaults
      const saved = loadPrefs();
      const defaults = { visibleFields: campi.map(c=>String(c.id)), start: startInput.min, end: '', theme: 'auto' };
      const prefs = Object.assign({}, defaults, saved || {});

      // apply dates
      startInput.value = prefs.start || startInput.min;
      endInput.value = prefs.end || '';

      // build UI
      buildFieldsList(prefs);
      document.getElementById('save-prefs').checked = !!saved;

      // theme
      $('#theme-select').value = prefs.theme || 'auto'; applyTheme(prefs.theme || 'auto');

      // attach handlers
      $('#btn-update').addEventListener('click', ()=>{
        const settings = gatherSettings(); renderCharts(settings); fetchAndRenderLast(); savePrefs(settings);
      });

      $('#btn-select-all').addEventListener('click', ()=>{ $all('#fields-list input[type=checkbox]').forEach(i=>i.checked=true); });
      $('#btn-clear-all').addEventListener('click', ()=>{ $all('#fields-list input[type=checkbox]').forEach(i=>i.checked=false); });

      $('#save-prefs').addEventListener('change', ()=>{
        if (!$('#save-prefs').checked) localStorage.removeItem(prefsKey);
      });

      $('#theme-select').addEventListener('change', ()=>{ applyTheme($('#theme-select').value); const s=gatherSettings(); savePrefs(s); });

      // field checkboxes changes -> auto-save if enabled
      document.getElementById('fields-list').addEventListener('change', ()=>{ const s=gatherSettings(); renderCharts(s); savePrefs(s); });

      // initial render
      const settings = gatherSettings(); renderCharts(settings); fetchAndRenderLast();
    }

    function gatherSettings(){
      const visible = $all('#fields-list input[type=checkbox]').filter(i=>i.checked).map(i=>i.getAttribute('data-field'));
      const s = { visibleFields: visible, start: $('#start-date').value, end: $('#end-date').value, theme: $('#theme-select').value };
      return s;
    }

    async function fetchAndRenderLast(){
      const last = await fetchLast(); buildCards(last);
    }

    /* ==================== THEME ==================== */
    function applyTheme(mode){
      const root = document.getElementById('app');
      if (mode === 'auto'){
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches;
        root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        root.setAttribute('data-theme', mode === 'dark' ? 'dark' : 'light');
      }
      // save theme select value already handled by listeners
    }

    /* ==================== START ==================== */
    
    async function calcolaAQI() {
      try {
        const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1`);
        const js = await res.json();
        const feed = js.feeds[0];

        const pm25 = parseFloat(feed.field6);
        const pm10 = parseFloat(feed.field7);

        document.getElementById('pm25-val').textContent = pm25;
        document.getElementById('pm10-val').textContent = pm10;

        function aqiFromBreakpoint(C, BPlo, BPhi, Ilo, Ihi) {
          return ((Ihi - Ilo) / (BPhi - BPlo)) * (C - BPlo) + Ilo;
        }

        function aqiPM25(C) {
          if (C <= 12.0) return aqiFromBreakpoint(C, 0, 12, 0, 50);
          if (C <= 35.4) return aqiFromBreakpoint(C, 12.1, 35.4, 51, 100);
          if (C <= 55.4) return aqiFromBreakpoint(C, 35.5, 55.4, 101, 150);
          if (C <= 150.4) return aqiFromBreakpoint(C, 55.5, 150.4, 151, 200);
          if (C <= 250.4) return aqiFromBreakpoint(C, 150.5, 250.4, 201, 300);
          if (C <= 350.4) return aqiFromBreakpoint(C, 250.5, 350.4, 301, 400);
          return aqiFromBreakpoint(C, 350.5, 500.4, 401, 500);
        }

        function aqiPM10(C) {
          if (C <= 54) return aqiFromBreakpoint(C, 0, 54, 0, 50);
          if (C <= 154) return aqiFromBreakpoint(C, 55, 154, 51, 100);
          if (C <= 254) return aqiFromBreakpoint(C, 155, 254, 101, 150);
          if (C <= 354) return aqiFromBreakpoint(C, 255, 354, 151, 200);
          if (C <= 424) return aqiFromBreakpoint(C, 355, 424, 201, 300);
          if (C <= 504) return aqiFromBreakpoint(C, 425, 504, 301, 400);
          return aqiFromBreakpoint(C, 505, 604, 401, 500);
        }

        const aqi25 = aqiPM25(pm25);
        const aqi10 = aqiPM10(pm10);
        const aqi = Math.round(Math.max(aqi25, aqi10));

        document.getElementById('aqi-value').textContent = aqi;

        let categoria = '';
        let colore = '';
        if (aqi <= 50) { categoria = 'Buona'; colore = '#4caf50'; }
        else if (aqi <= 100) { categoria = 'Moderata'; colore = '#ffeb3b'; }
        else if (aqi <= 150) { categoria = 'Insalubre per gruppi sensibili'; colore = '#ff9800'; }
        else if (aqi <= 200) { categoria = 'Insalubre'; colore = '#f44336'; }
        else if (aqi <= 300) { categoria = 'Molto Insalubre'; colore = '#9c27b0'; }
        else { categoria = 'Pericolosa'; colore = '#7e0023'; }

        const catBox = document.getElementById('aqi-category');
        catBox.textContent = categoria;
        catBox.style.background = colore;
        catBox.style.color = '#000';
      } catch (e) {
        document.getElementById('aqi-value').textContent = 'ERR';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      init();
      calcolaAQI();
    });('DOMContentLoaded', init);
  </script>
</body>
</html>

